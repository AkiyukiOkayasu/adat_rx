<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>adat_rx</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="theme/custom.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="adat_rx"><a class="header" href="#adat_rx">adat_rx</a></h2>
<p>ADATレシーバ トップモジュール</p>
<p>ADAT光入力から8チャンネル24ビットPCMをデコードする。
クロックはADAT信号から自動復元される（外部PLLは不要）。</p>
<h1 id="対応サンプルレート"><a class="header" href="#対応サンプルレート">対応サンプルレート</a></h1>
<ul>
<li>48kHz: 8チャンネル</li>
<li>96kHz: 4チャンネル (S/MUX2)</li>
<li>192kHz: 2チャンネル (S/MUX4)</li>
</ul>
<h1 id="adatフレーム構造-256-bits--48khz--2083us"><a class="header" href="#adatフレーム構造-256-bits--48khz--2083us">ADATフレーム構造 (256 bits @ 48kHz = 20.83us)</a></h1>
<p>5ビットニブル単位で構成。各ニブル: [4bit data][1bit separator=1]</p>
<h2 id="シリアル伝送順とビット有意性の定義"><a class="header" href="#シリアル伝送順とビット有意性の定義">シリアル伝送順とビット有意性の定義</a></h2>
<ul>
<li>シリアル伝送順: フレーム先頭から順方向（<code>build_frame[255]</code> → <code>build_frame[0]</code>）。</li>
<li>5bitニブルの伝送順: <code>D23..D20</code> のように data部は MSB-first。</li>
<li>PCM 24bit語のビット有意性: <code>o_channels[x][23]</code> がMSB、<code>o_channels[x][0]</code> がLSB。</li>
<li>したがって nibble 列 <code>D23..D20, D19..D16, ... D3..D0</code> は
<code>23:20, 19:16, ... 3:0</code> にそのまま対応する。</li>
</ul>
<body onload="WaveDrom.ProcessAll()">
<script type="WaveDrom">{
   signal: [
     {
       name: 'Field',
       wave: 'x3.........45...46...46...46...46...46...46...47...47...47...47...47...47...48...48...48...48...48...48...49...49...49...49...49...49...46...46...46...46...46...46...47...47...47...47...47...47...48...48...48...48...48...48...49...49...49...49...49...49...4x',
       data: [
         'SYNC', 'spr',
         'UserBit', 'spr',
         'CH0 nibble0', 'spr',
         'CH0 nibble1', 'spr',
         'CH0 nibble2', 'spr',
         'CH0 nibble3', 'spr',
         'CH0 nibble4', 'spr',
         'CH0 nibble5', 'spr',
         'CH1 nibble0', 'spr',
         'CH1 nibble1', 'spr',
         'CH1 nibble2', 'spr',
         'CH1 nibble3', 'spr',
         'CH1 nibble4', 'spr',
         'CH1 nibble5', 'spr',
         'CH2 nibble0', 'spr',
         'CH2 nibble1', 'spr',
         'CH2 nibble2', 'spr',
         'CH2 nibble3', 'spr',
         'CH2 nibble4', 'spr',
         'CH2 nibble5', 'spr',
         'CH3 nibble0', 'spr',
         'CH3 nibble1', 'spr',
         'CH3 nibble2', 'spr',
         'CH3 nibble3', 'spr',
         'CH3 nibble4', 'spr',
         'CH3 nibble5', 'spr',
         'CH4 nibble0', 'spr',
         'CH4 nibble1', 'spr',
         'CH4 nibble2', 'spr',
         'CH4 nibble3', 'spr',
         'CH4 nibble4', 'spr',
         'CH4 nibble5', 'spr',
         'CH5 nibble0', 'spr',
         'CH5 nibble1', 'spr',
         'CH5 nibble2', 'spr',
         'CH5 nibble3', 'spr',
         'CH5 nibble4', 'spr',
         'CH5 nibble5', 'spr',
         'CH6 nibble0', 'spr',
         'CH6 nibble1', 'spr',
         'CH6 nibble2', 'spr',
         'CH6 nibble3', 'spr',
         'CH6 nibble4', 'spr',
         'CH6 nibble5', 'spr',
         'CH7 nibble0', 'spr',
         'CH7 nibble1', 'spr',
         'CH7 nibble2', 'spr',
         'CH7 nibble3', 'spr',
         'CH7 nibble4', 'spr',
         'CH7 nibble5', 'spr',
       ]
     },
     {
       name: 'ADAT in',
       wave: '10.........1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1====1x',
       data: [
         'U3', 'U2', 'U1', 'U0',
         'D23', 'D22', 'D21', 'D20',
         'D19', 'D18', 'D17', 'D16',
         'D15', 'D14', 'D13', 'D12',
         'D11', 'D10', 'D9', 'D8',
         'D7', 'D6', 'D5', 'D4',
         'D3', 'D2', 'D1', 'D0',
         'D23', 'D22', 'D21', 'D20',
         'D19', 'D18', 'D17', 'D16',
         'D15', 'D14', 'D13', 'D12',
         'D11', 'D10', 'D9', 'D8',
         'D7', 'D6', 'D5', 'D4',
         'D3', 'D2', 'D1', 'D0',
         'D23', 'D22', 'D21', 'D20',
         'D19', 'D18', 'D17', 'D16',
         'D15', 'D14', 'D13', 'D12',
         'D11', 'D10', 'D9', 'D8',
         'D7', 'D6', 'D5', 'D4',
         'D3', 'D2', 'D1', 'D0',
         'D23', 'D22', 'D21', 'D20',
         'D19', 'D18', 'D17', 'D16',
         'D15', 'D14', 'D13', 'D12',
         'D11', 'D10', 'D9', 'D8',
         'D7', 'D6', 'D5', 'D4',
         'D3', 'D2', 'D1', 'D0',
         'D23', 'D22', 'D21', 'D20',
         'D19', 'D18', 'D17', 'D16',
         'D15', 'D14', 'D13', 'D12',
         'D11', 'D10', 'D9', 'D8',
         'D7', 'D6', 'D5', 'D4',
         'D3', 'D2', 'D1', 'D0',
         'D23', 'D22', 'D21', 'D20',
         'D19', 'D18', 'D17', 'D16',
         'D15', 'D14', 'D13', 'D12',
         'D11', 'D10', 'D9', 'D8',
         'D7', 'D6', 'D5', 'D4',
         'D3', 'D2', 'D1', 'D0',
         'D23', 'D22', 'D21', 'D20',
         'D19', 'D18', 'D17', 'D16',
         'D15', 'D14', 'D13', 'D12',
         'D11', 'D10', 'D9', 'D8',
         'D7', 'D6', 'D5', 'D4',
         'D3', 'D2', 'D1', 'D0',
         'D23', 'D22', 'D21', 'D20',
         'D19', 'D18', 'D17', 'D16',
         'D15', 'D14', 'D13', 'D12',
         'D11', 'D10', 'D9', 'D8',
         'D7', 'D6', 'D5', 'D4',
         'D3', 'D2', 'D1', 'D0'
       ]
     }
   ],
   head: { text: 'ADAT frame', tick: -1, every: 5 }
 }
</script>
<h2 id="詳細構成5ビットニブル単位"><a class="header" href="#詳細構成5ビットニブル単位">詳細構成（5ビットニブル単位）</a></h2>
<div class="table-wrapper"><table><thead><tr><th>ビット</th><th>内容</th><th>説明</th></tr></thead><tbody>
<tr><td>0-10</td><td>0000000000 + 1</td><td>SYNC: 10ビットの0（NRZIで無遷移） + separator=1</td></tr>
<tr><td>11-15</td><td>U3-U0 + 1</td><td>User nibble: User bits[3:0] + separator</td></tr>
<tr><td>16-20</td><td>D23-D20 + 1</td><td>CH0 nibble0: audio[23:20] + separator</td></tr>
<tr><td>21-25</td><td>D19-D16 + 1</td><td>CH0 nibble1: audio[19:16] + separator</td></tr>
<tr><td>26-30</td><td>D15-D12 + 1</td><td>CH0 nibble2: audio[15:12] + separator</td></tr>
<tr><td>31-35</td><td>D11-D8 + 1</td><td>CH0 nibble3: audio[11:8] + separator</td></tr>
<tr><td>36-40</td><td>D7-D4 + 1</td><td>CH0 nibble4: audio[7:4] + separator</td></tr>
<tr><td>41-45</td><td>D3-D0 + 1</td><td>CH0 nibble5: audio[3:0] + separator</td></tr>
<tr><td>46-75</td><td>...</td><td>CH1 (上記と同じ6 nibbles)</td></tr>
<tr><td>...</td><td>...</td><td>CH2-CH7 (各30ビット)</td></tr>
</tbody></table>
</div>
<h2 id="セパレーターの役割"><a class="header" href="#セパレーターの役割">セパレーターの役割</a></h2>
<ul>
<li>各5ビットニブルの最後に「1」が配置される</li>
<li>これによりNRZIエンコーディングで必ず遷移が発生</li>
<li>最大5ビット連続で無遷移になるのを防ぎ、同期を維持</li>
</ul>
<h1 id="使用例"><a class="header" href="#使用例">使用例</a></h1>
<pre><code class="language-veryl">inst adat: adat_rx (
    i_clk     : sys_clk_50mhz,
    i_rst     : reset,
    i_adat    : toslink_in,
    o_channels: audio_out,
    o_frame_clk: frame_clk,
);
</code></pre>
<h1 id="タイミング"><a class="header" href="#タイミング">タイミング</a></h1>
<ul>
<li>推奨クロック: 50MHz</li>
<li>ADAT入力: TOSLINK光→電気変換済み信号</li>
</ul>
<h3 id="ports"><a class="header" href="#ports">Ports</a></h3>
<hr />
<table class="table_list">
<tbody>
<tr>
    <th class="table_list_item">i_clk</th>
    <td class="table_list_item"><span class="hljs-keyword">input</span></td>
    <td class="table_list_item"><span class="hljs-type">clock</span></td>
    <td class="table_list_item"> システムクロック (50MHz推奨)
</td>
</tr>
<tr>
    <th class="table_list_item">i_rst</th>
    <td class="table_list_item"><span class="hljs-keyword">input</span></td>
    <td class="table_list_item"><span class="hljs-type">reset</span></td>
    <td class="table_list_item"> アクティブハイリセット
</td>
</tr>
<tr>
    <th class="table_list_item">i_adat</th>
    <td class="table_list_item"><span class="hljs-keyword">input</span></td>
    <td class="table_list_item"><span class="hljs-type">logic</span></td>
    <td class="table_list_item"> ADAT入力 (光→電気変換済み)
</td>
</tr>
<tr>
    <th class="table_list_item">o_frame_clk</th>
    <td class="table_list_item"><span class="hljs-keyword">output</span></td>
    <td class="table_list_item"><span class="hljs-type">logic</span></td>
    <td class="table_list_item"> ADATフレーム周期のクロック出力（sample rateではない）
 通常は44.1/48kHz。
 warning: S/MUX有効時でも44.1kHz/48kHzが出力されることに注意
</td>
</tr>
<tr>
    <th class="table_list_item">o_smux_active</th>
    <td class="table_list_item"><span class="hljs-keyword">output</span></td>
    <td class="table_list_item"><span class="hljs-type">logic</span></td>
    <td class="table_list_item"> 検出されたS/MUX有効状態 (1: enabled, 0: disabled)
 UserBit2による自動判定
 warning: UserBitによるS/MUX2とS/MUX4の区別は原理的に不可能なので、あくまでS/MUXが有効or無効のみを示す
</td>
</tr>
<tr>
    <th class="table_list_item">o_channels</th>
    <td class="table_list_item"><span class="hljs-keyword">output</span></td>
    <td class="table_list_item"><span class="hljs-type">logic<24> [8]</span></td>
    <td class="table_list_item"> 8チャンネルPCMデータ出力
</td>
</tr>
<tr>
    <th class="table_list_item">o_valid</th>
    <td class="table_list_item"><span class="hljs-keyword">output</span></td>
    <td class="table_list_item"><span class="hljs-type">logic</span></td>
    <td class="table_list_item"> データ有効信号
</td>
</tr>
<tr>
    <th class="table_list_item">o_locked</th>
    <td class="table_list_item"><span class="hljs-keyword">output</span></td>
    <td class="table_list_item"><span class="hljs-type">logic</span></td>
    <td class="table_list_item"> 同期ロック状態
</td>
</tr>
</tbody>
</table>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="modules.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="proto_modules.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="modules.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="proto_modules.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="theme/wavedrom.min.js"></script>
        <script src="theme/wavedrom_skin.js"></script>
        <script src="theme/mermaid.min.js"></script>



    </div>
    </body>
</html>
